<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Your Cart | Sabjiwala</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-50 min-h-screen">
  <%- include('partials/navbar') %>

  <main class="max-w-5xl mx-auto px-6 py-12">
    <h1 class="text-3xl font-extrabold text-green-700 mb-8">ðŸ›’ Your Cart</h1>
    <div id="cart-container" class="bg-white shadow rounded-lg p-6"></div>
  </main>

  <script>
    // backend se customer: req.user pass karo
    const customerLoggedIn = "<%- (typeof customer !== 'undefined' && customer) ? 'true' : 'false' %>";

    function getCart() {
      try {
        return JSON.parse(localStorage.getItem("cart") || "[]");
      } catch (e) {
        console.warn('Invalid cart JSON; resetting.', e);
        localStorage.removeItem("cart");
        return [];
      }
    }

    function saveCart(cart) {
      localStorage.setItem("cart", JSON.stringify(cart));
    }

    function removeFromCart(index) {
      const cart = getCart();
      cart.splice(index, 1);
      saveCart(cart);
      renderCart();
    }

    function prepareCartData() {
      const cart = getCart();
      const input = document.getElementById("cartData");
      if (input) input.value = JSON.stringify(cart);
    }

    function clearCartAfterCheckout() {
      // Clear cart after submission
      localStorage.removeItem("cart");
    }

    function renderCart() {
      const container = document.getElementById("cart-container");
      const cart = getCart();

      if (cart.length === 0) {
        container.innerHTML = '<p class="text-gray-600 text-lg">Your cart is empty.</p>';
        return;
      }

      let total = 0;
      let html = `
        <table class="table-auto w-full mb-6">
          <thead>
            <tr class="bg-green-100 text-left">
              <th class="px-4 py-2">Product</th>
              <th class="px-4 py-2">Vendor</th>
              <th class="px-4 py-2">Price</th>
              <th class="px-4 py-2">Quantity</th>
              <th class="px-4 py-2">Subtotal</th>
              <th class="px-4 py-2">Action</th>
            </tr>
          </thead>
          <tbody>
      `;

      cart.forEach((item, index) => {
        const priceNum = Number(item.price) || 0;
        const qtyNum = Number(item.qty) || 0;
        const subtotal = priceNum * qtyNum;
        total += subtotal;

        const productName = String(item.productName || '');
        const vendorName = String(item.vendorName || '');

        html += `
          <tr class="border-b">
            <td class="px-4 py-2">${productName}</td>
            <td class="px-4 py-2">${vendorName}</td>
            <td class="px-4 py-2">â‚¹${priceNum}</td>
            <td class="px-4 py-2">${qtyNum}</td>
            <td class="px-4 py-2 font-semibold">â‚¹${subtotal}</td>
            <td class="px-4 py-2">
              <button onclick="removeFromCart(${index})"
                class="bg-red-500 text-white px-3 py-1 rounded hover:bg-red-600">
                Remove
              </button>
            </td>
          </tr>
        `;
      });

      html += `
          </tbody>
        </table>
        <div class="flex flex-col sm:flex-row gap-4 sm:gap-6 justify-between items-start sm:items-center">
          <span class="text-xl font-bold text-green-700">Total: â‚¹${total}</span>
      `;

      if (customerLoggedIn === "true") {
        html += `
          <form action="/set-cart" method="POST" onsubmit="prepareCartData(); clearCartAfterCheckout();" class="flex items-center gap-3">
            <input type="hidden" name="cartData" id="cartData" />
            <button type="submit" class="bg-green-600 text-white px-5 py-2 rounded-lg hover:bg-green-700">
              Proceed to Checkout
            </button>
          </form>
        `;
      } else {
        html += `
          <a href="/login"
             class="bg-blue-600 text-white px-5 py-2 rounded-lg hover:bg-blue-700 font-semibold">
             Login to Checkout
          </a>
        `;
      }

      html += `
        </div>
      `;

      container.innerHTML = html;
    }

    renderCart();
  </script>
</body>
</html>
