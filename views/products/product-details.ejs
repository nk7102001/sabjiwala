<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title><%= (product && product.name) ? product.name : 'Product' %> | Sabjiwala</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    .zoomed {
      transform: scale(1.2);
      transition: transform 0.3s;
    }
  </style>
</head>

<body class="bg-gray-50 min-h-screen flex flex-col font-sans">

  <!-- ✅ Navbar -->
  <%- include('../partials/navbar') %>

  <!-- Main Product Section -->
  <main class="flex-grow max-w-6xl mx-auto w-full px-3 sm:px-6 lg:px-8 py-6 sm:py-10 grid grid-cols-1 md:grid-cols-2 gap-6 sm:gap-8">
    
    <!-- Left: Image -->
    <div class="relative w-full">
      <img
        src="<%= product && product.imageUrl ? product.imageUrl : '' %>"
        alt="<%= product && product.name ? product.name : 'Product image' %>"
        class="w-full h-72 sm:h-80 object-cover rounded-lg cursor-zoom-in shadow-sm"
        id="mainImage" />
    </div>

    <!-- Right: Info -->
    <div class="flex flex-col">
      <h1 class="text-2xl sm:text-3xl font-extrabold text-green-700"><%= product && product.name ? product.name : 'Product' %></h1>
      <p class="mt-3 text-gray-600 text-sm sm:text-base"><%= product && product.description ? product.description : '' %></p>
      <p class="mt-2 font-semibold text-base sm:text-lg text-yellow-700">
        Category: <%= product && product.category ? product.category : '' %>
      </p>

      <% if (product && product.inStock === false) { %>
        <p class="mt-2 text-red-600 font-bold">Out of Stock</p>
      <% } %>
    </div>
  </main>

  <!-- Vendors List -->
  <section class="max-w-6xl mx-auto px-3 sm:px-6 lg:px-8 mt-8">
    <h2 class="text-xl sm:text-2xl font-bold mb-4">Available Vendors</h2>
    <% const _vendors = Array.isArray(vendors) ? vendors : []; %>
    <% if (_vendors.length === 0) { %>
      <p class="text-gray-500 text-sm sm:text-base">No vendors currently selling this product.</p>
    <% } else { %>
      <ul class="space-y-4">
        <% _vendors.forEach((vendor) => { 
             const vp = (vendor && Array.isArray(vendor.products))
               ? vendor.products.find((p) => p.product && product && p.product.toString() === product._id.toString())
               : null;
        %>
          <li class="bg-white p-4 rounded-lg shadow flex flex-col sm:flex-row sm:justify-between sm:items-center gap-3">
            <div>
              <p class="font-bold text-green-700 text-sm sm:text-base">
                <%= vendor.shopName || vendor.name || 'Vendor' %>
              </p>
              <% if (vp) { %>
                <p class="text-xs sm:text-sm text-gray-500">
                  ₹<%= Number(vp.price || 0) %> / kg — <%= Number(vp.availableQty || 0) %> kg available
                </p>
              <% } %>
            </div>

            <% if (vp && Number(vp.availableQty || 0) > 0) { %>
              <form action="/cart/add-from-vendor" method="POST">
                <input type="hidden" name="productId" value="<%= product && product._id ? product._id : '' %>" />
                <input type="hidden" name="vendorId" value="<%= vendor && vendor._id ? vendor._id : '' %>" />
                <button class="bg-green-600 text-white px-3 sm:px-4 py-1.5 rounded hover:bg-green-700 text-sm sm:text-base w-full sm:w-auto">
                  Add to Cart
                </button>
              </form>
            <% } else { %>
              <button class="bg-gray-400 text-white px-3 sm:px-4 py-1.5 rounded text-sm sm:text-base w-full sm:w-auto" disabled>
                Out of Stock
              </button>
            <% } %>
          </li>
        <% }) %>
      </ul>
    <% } %>
  </section>

  <!-- Reviews Section -->
  <section id="reviews" class="max-w-6xl mx-auto px-3 sm:px-6 lg:px-8 mt-10 mb-20">
    <h2 class="text-xl sm:text-2xl font-bold mb-4">Customer Reviews</h2>

    <% const _reviews = Array.isArray(reviews) ? reviews : []; %>
    <!-- Reviews List -->
    <% if (_reviews.length === 0) { %>
      <p class="text-gray-500 text-sm sm:text-base">No reviews yet. Be the first to give feedback!</p>
    <% } else { %>
      <div class="space-y-4">
        <% _reviews.forEach((r) => { %>
          <div class="bg-white p-4 rounded-lg shadow">
            <p class="font-semibold text-sm sm:text-base"><%= r.name || 'Customer' %></p>
            <p class="text-yellow-500 text-sm sm:text-base">
              <% for (let i = 0; i < Number(r.rating || 0); i++) { %> ⭐ <% } %>
            </p>
            <p class="text-gray-600 text-sm sm:text-base"><%= r.review || '' %></p>
            <p class="text-xs text-gray-400"><%= r.createdAt ? new Date(r.createdAt).toDateString() : '' %></p>
          </div>
        <% }) %>
      </div>
    <% } %>

    <!-- Add Review Form -->
    <form action="/product/<%= product && product._id ? product._id : '' %>/reviews" method="POST"
          class="mt-6 space-y-4 bg-white p-4 rounded-lg shadow max-w-2xl">
      
      <input type="hidden" name="productSlug" value="<%= product && product.slug ? product.slug : '' %>" />

      <input type="text" name="name" placeholder="Your name" required
             class="w-full border rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-green-600 text-sm sm:text-base" />

      <select name="rating" required
              class="border rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-green-600 text-sm sm:text-base w-full">
        <option value="">Rating</option>
        <option value="5">⭐⭐⭐⭐⭐</option>
        <option value="4">⭐⭐⭐⭐</option>
        <option value="3">⭐⭐⭐</option>
        <option value="2">⭐⭐</option>
        <option value="1">⭐</option>
      </select>

      <textarea name="review" placeholder="Write your review..." required
                class="w-full border rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-green-600 text-sm sm:text-base"></textarea>

      <button type="submit"
              class="bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700 transition font-semibold text-sm sm:text-base">
        Submit Review
      </button>
    </form>
  </section>

  <!-- ✅ Image Zoom Script -->
  <script>
    (function () {
      const img = document.getElementById("mainImage");
      if (img) {
        img.addEventListener("click", () => img.classList.toggle("zoomed"));
      }
    })();
  </script>

  <!-- ✅ Footer -->
  <%- include('../partials/footer') %>

</body>
</html>
