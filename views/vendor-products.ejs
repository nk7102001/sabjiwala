<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title><%= vendor && vendor.shopName ? vendor.shopName : 'Vendor' %> | Sabjiwala</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-50 text-gray-800 font-sans">

  <!-- ‚úÖ Navbar -->
  <%- include('partials/navbar') %>

  <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">

    <!-- Vendor Info -->
    <section class="text-center mb-12">
      <% if (vendor && vendor.shopPhoto) { %>
        <img src="<%= vendor.shopPhoto %>"
             alt="<%= vendor.shopName || 'Vendor' %>"
             class="w-28 h-28 object-cover rounded-full mx-auto shadow mb-4 border border-gray-200">
      <% } else { %>
        <div class="w-28 h-28 mx-auto rounded-full bg-gray-100 flex items-center justify-center text-gray-400 text-sm shadow mb-4">
          No Image
        </div>
      <% } %>

      <h1 class="text-3xl font-bold text-green-700 mb-1"><%= vendor && vendor.shopName ? vendor.shopName : 'Vendor' %></h1>

      <% if (vendor && vendor.avgRating) { %>
        <p class="text-yellow-500 flex justify-center items-center gap-1">
          ‚≠ê <span class="font-medium"><%= vendor.avgRating.toFixed(1) %></span>
        </p>
      <% } else { %>
        <p class="text-gray-400">No ratings</p>
      <% } %>
    </section>

    <!-- Product List -->
    <% const _products = Array.isArray(products) ? products : []; %>
    <% if (_products.length === 0) { %>
      <p class="text-center text-gray-500 text-lg">This vendor has no products listed yet.</p>
    <% } else { %>
      <section class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6">
        <% _products.forEach((p) => { %>
          <div class="bg-white rounded-lg shadow hover:shadow-lg transition flex flex-col border border-gray-100">
            <!-- Product Image -->
            <% if (p.imageUrl) { %>
              <img src="<%= p.imageUrl %>"
                   alt="<%= p.name || 'Product' %>"
                   class="w-full h-40 object-cover rounded-t-lg">
            <% } else { %>
              <div class="w-full h-40 flex items-center justify-center bg-gray-100 text-gray-400 text-sm">
                No Image
              </div>
            <% } %>

            <!-- Product Details -->
            <div class="p-4 flex flex-col flex-grow">
              <h2 class="font-semibold text-lg text-gray-800 line-clamp-1"><%= p.name || 'Product' %></h2>
              <p class="text-green-600 font-bold mb-1">‚Çπ<%= Number(p.pricePerKg || 0) %> / Kg</p>

              <% const qty = Number(p.availableQty || 0); %>
              <% if (qty > 0) { %>
                <% if (qty <= 5) { %>
                  <p class="text-sm text-orange-500 font-medium mb-3">Only <%= qty %> kg left!</p>
                <% } else { %>
                  <p class="text-sm text-green-500 font-medium mb-3">In Stock</p>
                <% } %>
              <% } else { %>
                <p class="text-sm text-red-500 font-medium mb-3">Out of Stock</p>
              <% } %>

              <!-- ‚úÖ Add to Cart Form (LocalStorage) -->
              <% if (qty > 0) { %>
                <form onsubmit="addToCart(event)" class="mt-auto flex items-center gap-2">
                  <input type="hidden" name="vendorId" value="<%= vendor && vendor._id ? vendor._id : '' %>">
                  <input type="hidden" name="vendorName" value="<%= vendor && vendor.shopName ? vendor.shopName : '' %>">
                  <input type="hidden" name="productId" value="<%= p._id %>">
                  <input type="hidden" name="productName" value="<%= p.name || '' %>">
                  <input type="hidden" name="price" value="<%= Number(p.pricePerKg || 0) %>">

                  <input type="number" name="qty" value="1" min="1" max="<%= qty %>"
                         class="border border-gray-300 rounded px-2 py-1 w-16 text-center">

                  <button type="submit"
                          class="flex-1 bg-green-500 hover:bg-green-600 text-white py-2 rounded transition">
                    üõí Add to Cart
                  </button>
                </form>
              <% } %>
            </div>
          </div>
        <% }) %>
      </section>
    <% } %>
  </main>

  <!-- ‚úÖ Footer -->
  <%- include('partials/footer') %>

  <!-- üìú LocalStorage AddToCart Script -->
  <script>
    function addToCart(e) {
      e.preventDefault();

      const form = e.target;
      const item = {
        vendorId: form.vendorId.value,
        vendorName: form.vendorName.value,
        productId: form.productId.value,
        productName: form.productName.value,
        price: parseFloat(form.price.value) || 0,
        qty: parseInt(form.qty.value, 10) || 1
      };

      let cart = [];
      try {
        cart = JSON.parse(localStorage.getItem("cart") || "[]");
        if (!Array.isArray(cart)) cart = [];
      } catch {
        cart = [];
      }

      // Agar same product+vendor hai to qty update karo
      const index = cart.findIndex((i) => i.vendorId === item.vendorId && i.productId === item.productId);
      if (index > -1) {
        cart[index].qty += item.qty;
      } else {
        cart.push(item);
      }

      localStorage.setItem("cart", JSON.stringify(cart));

      // ‚úÖ Show toast instead of ugly alert
      showToast("‚úÖ Item added to cart!");
    }

    // Toast function
    function showToast(message) {
      const toast = document.createElement("div");
      toast.innerText = message;
      toast.className = "fixed bottom-6 right-6 bg-green-600 text-white px-4 py-2 rounded shadow-lg text-sm animate-fadeIn z-50";
      document.body.appendChild(toast);

      // Remove after 3 seconds
      setTimeout(() => {
        toast.remove();
      }, 3000);
    }
  </script>

  <style>
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    .animate-fadeIn {
      animation: fadeIn 0.3s ease forwards;
    }
  </style>

</body>
</html>
